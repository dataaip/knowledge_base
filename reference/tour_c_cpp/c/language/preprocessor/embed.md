C 二元资源包含 （自 C23 起）

#embed 是一个预处理器指令，用于在构建中包含（二进制）资源，其中资源被定义为可从翻译环境访问的数据源。

语法
#embed <h-char-sequence>embed-parameter-sequence（可选） 换行	(1)	
#embed “q-char-sequence”embed-parameter-sequence（可选） 换行	(2)	
#embedpp-tokens 换行符	(3)	
__has_embed（“q-char-sequence”embed-parameter-sequence（可选））
__has_embed（<h-char-sequence>embed-parameter-sequence（可选））	(4)	
__has_embed（ 字符串文字 pp-balanced-token-sequence（可选））
__has_embed（<h-pp-tokens>pp-balanced-token-sequence（可选））	(5)	
1） 搜索由 h-char-sequence 唯一标识的资源，并将指令替换为与资源数据相对应的逗号分隔的整数列表。
2） 搜索由 q-char-sequence 标识的资源，并将指令替换为与资源数据相对应的整数列表。它可以回退到 （1）。
3） 如果 （1） 和 （2） 都不匹配，则 pp-token 将进行宏替换。替换后的指令将再次尝试与 （1） 或 （2） 匹配。
4） 检查资源是否可用于嵌入，是否为空，传递的参数是否被实现支持。
5） 如果 （4） 不匹配，h-pp-tokens 和 pp-balanced-token-sequence 将进行宏替换。替换后的指令将再次尝试与 （4） 匹配。
换行符	-	换行符
h-char 序列	-	一个或多个 h-char 的序列，其中出现以下任何一项会导致未定义的行为：
字符 '
角色 ”
字符 \
字符序列
字符序列 /*
H-字符	-	源字符集的任何成员，换行符和 > 除外
q-char 序列	-	一个或多个 q-chars 的序列，其中出现以下任何一项会导致未定义的行为：
字符 '
字符 \
字符序列
字符序列 /*
q-字符	-	源字符集的任何成员，换行符和 ”
pp 代币	-	一个或多个预处理令牌的序列
字符串文字	-	字符串文字
h-pp 代币	-	一个或多个预处理标记的序列，>
嵌入参数序列	-	一个或多个 pp 参数 s 的序列。请注意，与属性列表不同，此序列不以逗号分隔。
pp 参数	-	属性令牌 （参见： 属性 ），但由预处理令牌而不是令牌组成。
pp-平衡令牌序列	-	平衡令牌序列 （参见： 属性 ），但由预处理令牌而不是令牌组成
解释
1） 以实现定义的方式搜索由 h-char-sequence 标识的资源。
2） 以实现定义的方式搜索由 q-char-sequence 标识的资源。对于 （1,2）， 实现通常使用一种机制，类似于用于包含源文件的实现定义的搜索路径，但又不同。结构 __has_embed（__FILE__ ... 出现在标准中的一个示例中，至少在第 （2） 个情况下，建议至少在第 （2） 个情况下，应搜索当前文件所在的目录。
3） 嵌入指令后的预处理标记与在普通文本中一样处理（即，当前定义为宏名称的每个标识符都被其预处理标记的替换列表替换）。所有替换后产生的指令应与前两种形式之一相匹配。将 < 和 > 预处理标记对或一对 “ 字符之间的预处理标记序列组合成单个标头名称预处理标记的方法是实现定义的。
4） 搜索由 h-char-sequence 或 q-char-sequence 标识的资源，就好像该预处理标记序列是语法 （3） 中的 pp-tokens 一样，只是没有执行进一步的宏扩展。如果这样的指令不能满足 #embed 指令的语法要求，则程序格式不正确。__has_embed 表达式的计算结果是 __STDC_EMBED_FOUND__ 资源的搜索是否成功、资源是否为空且支持所有参数，__STDC_EMBED_EMPTY__ 资源是否为空且所有参数都受支持，以及 __STDC_EMBED_NOT_FOUND__ 搜索失败或实现不支持传递的参数之一。
5） 仅当语法 （4） 不匹配时才考虑此形式，在这种情况下，预处理标记的处理方式与普通文本相同。
如果找不到资源或实现不支持其中一个参数，则程序格式错误。

__has_embed 可以在 和 #elif 的 #if 表达式中展开。它被 #ifdef 、 、 #ifndef #elifdef #elifndef 和 defined 视为定义的宏，但不能在其他任何地方使用。

资源具有实现资源宽度 ，该宽度是实现定义的定位资源的大小（以位为单位）。它的资源宽度是实现资源宽度，除非被限制参数修改。如果资源宽度为 0，则资源被视为空。 嵌入元素宽度等于 CHAR_BIT，除非由实现定义的参数修改。资源宽度必须能被嵌入元素宽度整除。

#embed 指令的扩展是由下面描述的整数常量表达式列表形成的标记序列。列表中每个整数常量表达式的标记组在标记序列中与列表中前一个整数常量表达式的标记组用逗号分隔。序列既不以逗号开始也不以逗号结束。如果整数常量表达式列表为空，则标记序列为空。该指令被其扩展所取代，并且在存在某些嵌入参数的情况下，附加或替换标记序列。

扩展序列中整数常量表达式的值由实现定义的资源数据映射确定。每个整数常量表达式的值都在 [0， 2embed element width） 范围内。如果：

整数常量表达式列表用于初始化与无符号 char 兼容的数组，或者如果 char 不能保存负值，则与 char 兼容，并且
嵌入元素宽度等于 CHAR_BIT，
然后，数组的初始化元素的内容就像资源的二进制数据在转换时被 fread 到数组中一样。

鼓励实现考虑转换时间位和字节顺序以及执行时间位和字节顺序，以更适当地表示指令中资源的二进制数据。这最大限度地提高了这样一种可能性，如果在转换时通过 #embed 指令引用的资源与通过执行时方式访问的资源相同，则 fread 或类似数据进入连续存储的数据将逐位比较等于从 #embed 指令的扩展内容初始化的字符类型数组。

参数
该标准定义了参数限制、 前缀 、 后缀和 if_empty。指令中出现的任何其他参数都必须是实现定义的，否则程序格式不正确。实现定义的嵌入参数可能会更改指令的语义。

限制
limit（ 常量表达式 ）	(1)	
__limit__（ 常量表达式 ）	(2)	
limit embed 参数在嵌入参数序列中最多只能出现一次。它必须有一个参数，该参数必须是一个整数（预处理器） 常量表达式，该表达式的计算结果为非负数，并且不包含定义的标记。资源宽度设置为整数常量表达式乘以嵌入元素宽度和实现资源宽度的最小值。

后缀
suffix（pp-balanced-token-sequence（可选））	(1)	
__suffix__（pp-balanced-token-sequence（可选））	(2)	
后缀嵌入参数在嵌入参数序列中最多出现一次。它必须有一个（可能是空的）预处理器参数子句。如果资源为非空，则参数子句的内容将立即放置在指令扩展之后。否则，它没有效果。

前缀
前缀（pp-balanced-token-sequence（可选））	(1)	
__prefix__（pp-balanced-token-sequence（可选））	(2)	
前缀嵌入参数在嵌入参数序列中最多只能出现一次。它必须有一个（可能是空的）预处理器参数子句。如果资源为非空，则参数子句的内容将紧接在指令的扩展之前放置。否则，它没有效果。

if_empty
if_empty（pp-balanced-token-sequence（可选））	(1)	
__if_empty__（pp-balanced-token-sequence（可选））	(2)	
if_empty 嵌入参数在嵌入参数序列中最多只能出现一次。它必须有一个（可能是空的）预处理器参数子句。如果资源为空，则 parameter 子句的内容将替换指令。否则，它没有效果。

例
运行此代码
#include <stdint.h>
#include <stdio.h>
 
const uint8_t image_data[] =
{
#embed "image.png"
};
 
const char message[] =
{
#embed "message.txt" if_empty('M', 'i', 's', 's', 'i', 'n', 'g', '\n')
,'\0' // null terminator
};
 
void dump(const uint8_t arr[], size_t size)
{
    for (size_t i = 0; i != size; ++i)
        printf("%02X%c", arr[i], (i + 1) % 16 ? ' ' : '\n');
    puts("");
}
 
int main()
{
    puts("image_data[]:");
    dump(image_data, sizeof image_data);
    puts("message[]:");
    dump((const uint8_t*)message, sizeof message);
}
可能的输出：

image_data[]:
89 50 4E 47 0D 0A 1A 0A 00 00 00 0D 49 48 44 52
00 00 00 01 00 00 00 01 01 03 00 00 00 25 DB 56
...
message[]:
4D 69 73 73 69 6E 67 0A 00
引用
C23 标准 （ISO/IEC 9899：2024）：
6.4.7 标题名称（第 69 页）
6.10.1 有条件纳入（第 165-169 页）
6.10.2 二元资源包含（第 170-177 页）
另请参阅
资源包含的 C++ 文档 （从 C++26 开始）
