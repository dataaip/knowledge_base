# C 语言字符集与编码详解

  [1. 基本字符集（Basic Character Set）](#1-基本字符集basic-character-set)
  
  [2. 基本执行字符集（Basic Execution Character Set）](#2-基本执行字符集basic-execution-character-set)
  
  [3. 字面量编码（Literal Encoding）](#3-字面量编码literal-encoding)
  
  [4. 宽字符与多字节编码](#4-宽字符与多字节编码)
  
  [5. 实践举例](#5-实践举例)
  
  [6. 参考资料](#6-参考资料)

这些概念描述了 C 语言从源代码编写到程序执行整个过程中，如何处理字符信息。它们定义了哪些字符可以被使用、如何存储以及如何转换。

## 1. 基本字符集（Basic Character Set）

这是 C 语言标准规定，在编写源代码时必须支持的最小字符集合，包含 95 个可打印字符和若干控制字符。也就是说，任何一个符合标准的 C 编译器都必须能够识别和处理包含这些字符的源代码文件，它关注的是源代码里能出现什么字符。

**关键点**：

- 作用域：源代码文本本身。
- 意义：保证了 C 源码的最低可移植性。如果你只使用基本字符集写代码，那么这份代码在任何兼容的编译器上都能被正确解析，无论该编译器运行在什么系统上。
- 注意：源代码文件的实际编码（如 UTF-8, GBK, ISO-8859-1）可以包含更多字符（如中文注释），但这超出了 基本字符集 的定义。编译器需要知道源文件的编码才能正确解析这些额外字符。

**基本字符集**：主要包括以下几类（共 96 个字符）：

- 字母 (52个): 大写字母 A - Z， 小写字母 a - z
- 数字 (10个): 0 - 9
- 空白符 (5个): 空格 ( )、水平制表符 (\t)、垂直制表符 (\v)、换页符 (\f)、换行符 (\n)
- 图形字符 (29个):
- _ { } [ ] # ( ) < > % : ; . ? * + - / ^ & | ~ ! = , \ " '

| 代码点   | 字符 | 字形/说明 |
|----------|------|-----------|
| U+0009   | \t   | 制表符（Tab）|
| U+000B   | \v   | 垂直制表符（Vertical Tab）|
| U+000C   | \f   | 换页符（Form Feed, FF）|
| U+0020   |      | 空格 |
| U+0021   | !    | 感叹号 |
| U+0022   | "    | 双引号 |
| U+0023   | #    | 井号 |
| U+0025   | %    | 百分号 |
| U+0026   | &    | 和号 |
| U+0027   | '    | 单引号 |
| U+0028   | (    | 左括号 |
| U+0029   | )    | 右括号 |
| U+002A   | *    | 星号 |
| U+002B   | +    | 加号 |
| U+002C   | ,    | 逗号 |
| U+002D   | -    | 减号/连字符 |
| U+002E   | .    | 句号 |
| U+002F   | /    | 斜杠 |
| U+0030..U+0039 | 0..9 | 数字 0~9 |
| U+003A   | :    | 冒号 |
| U+003B   | ;    | 分号 |
| U+003C   | <    | 小于号 |
| U+003D   | =    | 等号 |
| U+003E   | >    | 大于号 |
| U+003F   | ?    | 问号 |
| U+0041..U+005A | A..Z | 大写字母 |
| U+005B   | [    | 左方括号 |
| U+005C   | \\   | 反斜杠 |
| U+005D   | ]    | 右方括号 |
| U+005E   | ^    | 脱字符 |
| U+005F   | _    | 下划线 |
| U+0061..U+007A | a..z | 小写字母 |
| U+007B   | {    | 左花括号 |
| U+007C   | |    | 竖线 |
| U+007D   | }    | 右花括号 |
| U+007E   | ~    | 波浪号 |

> **注意**：与 C++ 不同，U+000A 换行符（LF）不在 C 的基本字符集中。C 要求每行文本以某种方式标示行结束，文档会将其视为单独的换行符。

---

## 2. 基本执行字符集（Basic Execution Character Set）

基本执行字符集 这是在程序运行时，环境必须支持的最小字符集合。它包含了 基本字符集 的所有字符，并额外增加了几个控制字符，它关注的是 程序在内存里实际怎么存这些字符、怎么处理它们。

**关键点**：

- 作用域：运行时的程序环境。
- 意义：保证了程序运行时，这些核心字符的存在和行为是一致的。例如，无论程序在 Windows 还是 Linux 上运行，\n（换行）和 \0（字符串终止符）的含义都是确定的。
- 执行字符集编码：这些字符在内存中如何用数字（编码）表示是由执行字符集决定的。通常，对 于 char 类型，这就是 ASCII 编码。数字 48 表示字符 '0'，65 表示 'A'，等等。

**主要包括**：

- 基本字符集中的所有字符
- 控制字符： 警报 (\a)、回退符 (\b)、回车 (\r)、终止符（空字符 \0）

| 代码点 | 字符 | 说明 |
|--------|------|------|
| U+0000 | \0   | 空字符（字符串结束）|
| U+0007 | \a   | 响铃 |
| U+0008 | \b   | 退格 |
| U+000A | \n   | 换行（Line Feed）|
| U+000D | \r   | 回车（Carriage Return）|

对于每个基本执行字符集，每个成员的值应为非负且唯一。0 之后的每个字符的值应比前一个大 1，U+0000 的值为 0。每个成员的表示应适合于一个字节。

> 在 C++ 中，基本执行字符集也称为基本字面量字符集和基本执行宽字符集。

**基本字符集 vs. 基本执行字符集**：

可以把它们看作 编译时 和 运行时 的两个对应集合。前者用于写代码，后者用于程序执行，它们的内容绝大部分是重叠的。

---

## 3. 字面量编码（Literal Encoding）

字面量编码是将执行字符集中的字符映射到字符常量或字符串字面量的实现定义过程（无编码前缀）。它支持所有基本执行字符集的值映射到实现定义的编码，可能包含多字节字符序列。这个过程连接了 源代码字符集 和 执行字符集。

**定义**：编译器在编译阶段，将源代码中的字符常量和字符串字面量（例如 'A', "Hello"）从源代码字符集转换到执行字符集的过程。

**流程详解**：

- 你写下代码：char str[] = "中文";
- 你的源代码文件可能是以 UTF-8 编码保存的。"中" 字在 UTF-8 中由 3 个字节 0xE4 0xB8 0xAD 表示。
- 编译器读取源码时，必须知道源文件的编码（通常通过编译器标志指定，如 GCC 的 -finput-charset=UTF-8），这样才能正确理解 "中" 字。
- 在编译阶段，编译器会将字符串 "中文" 从 UTF-8 编码（源代码字符集）转换为执行字符集编码（例如，如果执行字符集是 UTF-8，则不变；如果执行字符集是 GBK，则转换为 GBK 的编码 0xD6 0xD0）。
- 最终，转换后的字节序列被写入最终的可执行文件中。程序运行时，str 数组里存放的就是转换后的字节。

**关键点**：

- 这是一个编译期行为。
- 如果编译器无法完成这个转换（例如，执行字符集是 ASCII，而源代码中有一个汉字），通常会产生一个警告或错误。
- 现代编译器（如 GCC、Clang）通常默认将执行字符集设置为 UTF-8，这使得处理多字节文字更加方便。

**特殊字符**：

以下字符不在基本执行字符集，但在普通字符常量或字符串字面量中必须作为单字节编码：

| 代码点 | 字符 | 说明 |
|--------|------|------|
| U+0024 | $    | 美元符号 |
| U+0040 | @    | 商业 at |
| U+0060 | `    | 反引号 |

---

## 4. 宽字符与多字节编码

这是 C 标准为了支持国际化和本地化而提供的机制，用于处理远超基本字符集范围的字符（如中文、日文、阿拉伯文等）。

**多字节编码 (Multibyte Encoding)**：

- 定义：一种表示大量字符的编码方式，其中每个字符可能由一个或多个字节组成。
- 常见例子：UTF-8, GBK, BIG5, Shift-JIS。
- 特点：与传统的单字节 char 类型和字符串兼容。是变长的。ASCII 字符（0-127）通常占 1 个字节，其他字符占 2-4 个字节。字符串的处理变得复杂，你不能简单地通过指针算术来计数字符（strlen 返回的是字节数，不是字符数）。
- 在 C 中的使用：普通的 char[] 字符串就可以用来存储多字节字符串。标准库提供了 mblen(), mbtowc(), wctomb(), mbstowcs(), wcstombs() 等函数在多字节字符和宽字符之间进行转换。

**宽字符 (Wide Characters)**：

- 定义：为了解决多字节字符串处理的复杂性而引入。它使用一个固定长度的编码单元来表示一个字符，无论该字符是什么。
- 类型：wchar_t（定义在 <stddef.h> 头文件中），其大小由编译器实现决定（在 Linux 上通常是 4 字节 UTF-32，在 Windows 上通常是 2 字节 UTF-16）。
- 字面量：使用前缀 L，例如 L'中', L"中文"。
- 特点：每个 wchar_t 变量或数组元素通常对应一个逻辑字符。字符串操作变得简单，类似于处理 ASCII 字符串（wcslen() 可以准确返回宽字符的个数）。浪费空间，尤其是对于以 ASCII 字符为主的文本。
- 库函数：有一套对应的宽字符函数，如 wcslen(), wcscpy(), wprintf() 等，定义在 <wchar.h> 中。

**宽字符字面量编码**：

宽字符字面量编码是将执行字符集中的字符映射到以 L 为前缀的字符常量或字符串字面量的实现定义过程。若实现未定义 `__STDC_MB_MIGHT_NEQ_WC__`，则宽字符字面量编码与普通字面量编码一致。

**UTF-8/UTF-16/UTF-32 字面量编码**：

- `u8` 前缀：UTF-8 编码（C11 起）
- `u` 前缀：UTF-16 编码（C23 起）
- `U` 前缀：UTF-32 编码（C23 起）

这些编码用于将执行字符集中的字符映射到对应的多字节字符常量或字符串字面量。

> 现代 C（ C11 及以上）的建议：为了更明确的字符大小，C11 引入了 char16_t (用于 UTF-16) 和 char32_t (用于 UTF-32) 类型以及相应的字面量前缀 u 和 U。对于新项目，处理 Unicode 时，通常首选：用 char 和 UTF-8 编码存储和交换文本。如果需要内部固定长度表示，使用 char32_t（UTF-32）比 wchar_t 更具可移植性。

---

## 5. 实践举例

### 5.1 判断字符是否为字母或数字

```c
#include <stdio.h>
#include <ctype.h>
int main(void) {
	char c = 'A';
	if (isalpha(c)) printf("字母\n");
	if (isdigit(c)) printf("数字\n");
	return 0;
}
```

### 5.2 字符编码与字符串

```c
#include <stdio.h>
int main(void) {
	char s[] = "Hello, 世界";
	printf("%s\n", s); // 可能因编码不同而输出不同
	return 0;
}
```

---

## 6. 参考资料

- ISO/IEC 9899:2018 (C18) - Programming languages — C
- cppreference.com
