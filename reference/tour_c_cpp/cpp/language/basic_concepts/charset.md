# C++ 语言字符集与编码详解

  [1. 概述与标准术语](#1-概述与标准术语)
  
  [2. 翻译字符集（Translation Character Set）](#2-翻译字符集translation-character-set)
  
  [3. 基本字符集（Basic Character Set）](#3-基本字符集basic-character-set)
  
  [4. 基本字面量字符集（Basic Literal Character Set）](#4-基本字面量字符集basic-literal-character-set)
  
  [5. 执行字符集与宽字符集](#5-执行字符集与宽字符集)
  
  [6. 代码单元与字面量编码](#6-代码单元与字面量编码)
  
  [7. 标准术语变更与兼容性](#7-标准术语变更与兼容性)
  
  [8. 缺陷报告与标准修订](#8-缺陷报告与标准修订)
  
  [9. 实践举例](#9-实践举例)
  
  [10. 参考资料](#10-参考资料)

## 1. 概述与标准术语

C++ 标准定义了多种字符集及其编码方式，涉及源代码的存储、翻译、执行等多个阶段。理解这些字符集对于跨平台开发、国际化和底层编程尤为重要。

---

## 2. 翻译字符集（Translation Character Set）

这是整个编译过程的起点和基础。

**定义**：

翻译字符集是编译器内部使用的一种标准编码格式，用于统一表示所有源代码字符。无论您的源代码文件本身采用何种物理编码（如 UTF-8、GBK、ISO-8859-1），编译器在解析之前，都会先将其内容转换到翻译字符集。

**目的**：

将各种来源的源代码统一转换为一个编译器内部一致的表示形式，从而屏蔽源文件物理编码的差异，确保编译过程的一致性。这是实现 编译器可处理任何编码源文件 这一能力的关键步骤。

**C++ 标准规定**：

翻译字符集必须能够表示基本源字符集（见下文）中的所有字符。其编码方式是基于 ISO/IEC 10646（即 Unicode 标准）的某个编码形式（如 UTF-8、UTF-16 或 UTF-32）。简单理解，翻译字符集就是一种 Unicode 编码。

**流程举例**：

您用 Visual Studio 在 Windows 上创建了一个默认编码为 GBK 的源文件，其中包含中文字符。当 GCC（通常在 Linux 环境下使用，默认期望 UTF-8）尝试编译它时，GCC 会先尝试将 GBK 编码的字节序列转换到其内部的翻译字符集（Unicode），如果无法转换，则会报错或产生警告。这就是为什么有时需要用 -finput-charset 等编译器选项来明确指定源文件编码的原因。

翻译字符集是 C++ 源代码在翻译阶段使用的字符集合：

- 每个抽象字符在 Unicode 代码空间中分配唯一代码点。
- 未分配给抽象字符的 Unicode 标量值也会指定独特字符。
- 翻译字符集是基本字符集和基本字面量字符集的超集。

> 自 C++23 起，翻译字符集的定义与 Unicode 标准紧密对齐。

---

## 3. 基本字符集（Basic Character Set）

这是 C++ 标准规定，在逻辑层面上，一个符合标准的 C++ 编译器必须能够识别和处理的最小源字符集合，保证你写的 C++ 代码在任何标准编译器上都能被识别。

**定义**：

它是在翻译字符集的基础上定义的，是编译器进行词法和语法分析时所依赖的核心字符集合。它包含了构成 C++ 语言所有关键字、标识符、操作符和标点所必需的字符。

**内容**：

与 C 语言的基本字符集基本相同，包括

- 所有大小写拉丁字母（A-Z, a-z）
- 数字（0-9）
- 空白符（空格、换行、制表符等）
- 以及以下图形字符：_ { } [ ] # ( ) < > % : ; . ? * + - / ^ & | ~ ! = , \ " '

**关键点**：

基本字符集是一个逻辑集合，而不是一种编码。它规定的是 编译器必须能理解哪些字符，而这些字符在翻译字符集中都有对应的码位（Code Point）。

**组成**：

基本字符集包含 96 个字符（C++26 起为 99 个）：

| 代码点   | 字符 | 字形/说明 |
|----------|------|-----------|
| U+0009   | \t   | 制表符（Tab）|
| U+000B   | \v   | 垂直制表符（Vertical Tab）|
| U+000C   | \f   | 换页符（Form Feed, FF）|
| U+0020   |      | 空格 |
| U+000A   | \n   | 换行符（Line Feed, 新行）|
| U+0021   | !    | 感叹号 |
| U+0022   | "    | 双引号 |
| U+0023   | #    | 井号 |
| U+0025   | %    | 百分号 |
| U+0026   | &    | 和号 |
| U+0027   | '    | 单引号 |
| U+0028   | (    | 左括号 |
| U+0029   | )    | 右括号 |
| U+002A   | *    | 星号 |
| U+002B   | +    | 加号 |
| U+002C   | ,    | 逗号 |
| U+002D   | -    | 减号/连字符 |
| U+002E   | .    | 句号 |
| U+002F   | /    | 斜杠 |
| U+0030..U+0039 | 0..9 | 数字 0~9 |
| U+003A   | :    | 冒号 |
| U+003B   | ;    | 分号 |
| U+003C   | <    | 小于号 |
| U+003D   | =    | 等号 |
| U+003E   | >    | 大于号 |
| U+003F   | ?    | 问号 |
| U+0041..U+005A | A..Z | 大写字母 |
| U+005B   | [    | 左方括号 |
| U+005C   | \\   | 反斜杠 |
| U+005D   | ]    | 右方括号 |
| U+005E   | ^    | 脱字符 |
| U+005F   | _    | 下划线 |
| U+0061..U+007A | a..z | 小写字母 |
| U+007B   | {    | 左花括号 |
| U+007C   | |    | 竖线 |
| U+007D   | }    | 右花括号 |
| U+007E   | ~    | 波浪号 |

**C++26 新增字符**：

| 代码点 | 字符 | 说明 |
|--------|------|------|
| U+0024 | $    | 美元符号 |
| U+0040 | @    | 商业 at |
| U+0060 | `    | 反引号 |

---

## 4. 基本字面量字符集（Basic Literal Character Set）

这个术语在 C++ 标准中并不作为一个独立的正式术语出现。它通常指的是用于构成预处理记号的字符，这些字符将在后续阶段被转换为执行字符集。

**理解**：

您可以将其视为基本字符集的一个超集。它不仅包含了基本字符集中的所有字符，还包括了用于构成字符常量和字符串字面量的所有可表示字符，是 能出现在字符常量和字符串字面量里的所有字符。

**作用**：

在预处理阶段，编译器会识别出源码中的字符常量（如 'A'）和字符串字面量（如 "Hello"）。这些字面量中的字符，即使不属于基本字符集（例如一个中文字符），只要它们能被翻译字符集所表示，就属于这个范畴。

**后续处理**：

这些字面量中的字符，会在后续的字面量编码阶段被转换为执行字符集。

基本字面量字符集 = 基本字符集 + 以下控制字符：

| 代码点 | 字符 | 说明 |
|--------|------|------|
| U+0000 | \0   | 空字符（字符串结束）|
| U+0007 | \a   | 响铃 |
| U+0008 | \b   | 退格 |
| U+000D | \r   | 回车（Carriage Return）|

---

## 5. 执行字符集与宽字符集

这是程序运行时所使用的字符编码环境。执行字符集和执行宽字符集是基本字面量字符集的超集。其编码和附加元素集（如扩展字符）由实现和区域设置决定。

**执行字符集 (Execution Character Set)**：

- 定义：用于解释在程序执行环境中使用的窄字符（char） 和窄字符串字面量的编码。
- 内容：它包含了基本执行字符集，即基本字符集的所有字符加上重要的控制字符（如空字符\0、换行\n、警报\a等）。此外，实现还可以扩展支持更多字符。
- 常见编码：通常是某种区域性的单字节或多字节编码，如 ASCII（最常见）、ISO-8859-1（Latin-1），或者在现代系统中越来越普遍的 UTF-8。
- 转换：在编译期，编译器会将翻译字符集中的字符和字符串字面量转换到执行字符集。这个转换过程就是字面量编码。如果某个字符（如一个汉字）在执行字符集中没有表示，转换结果将由实现定义（通常是变成一个占位符或导致编译错误）。

**宽执行字符集 (Wide Execution Character Set)**：

- 定义：用于解释在程序执行环境中使用的宽字符（wchar_t） 和宽字符串字面量（如 L"中文"）的编码。
- 目的：解决窄字符集无法表示所有语言字符的问题。宽字符通常使用更大的固定编码单元来表示一个字符。
- 常见编码：wchar_t 的编码由实现定义。在 Windows 上，wchar_t 是 16 位，通常编码为 UTF-16。在大多数类 Unix 系统（如 Linux）上，wchar_t 是 32 位，通常编码为 UTF-32。
- 现代替代品：C++11 引入了更具可移植性的新类型 char16_t 和 char32_t，以及相应的字面量前缀 u 和 U，其编码明确为 UTF-16 和 UTF-32，推荐在新的项目中使用它们来代替 wchar_t。
- 执行宽字符集中的每个元素都必须能表示为不同的 `wchar_t` 代码单元。

---

## 6. 代码单元与字面量编码

- 代码单元：字符类型的整数值，存储字符的最小整数单元（如 char、wchar_t、char16_t、char32_t）。
- 字面量编码：根据编码前缀（如无前缀、L、u8、u、U）将字符映射为一个或多个代码单元，编译器把字面量里的字符（如 "中"）转成对应的代码单元（如 UTF-8/UTF-16/UTF-32 的字节序列）的过程。

**普通与宽字面量编码**：

- 普通字面量编码：应用于普通字符/字符串字面量。
- 宽字面量编码：应用于宽字符/字符串字面量。

**多字节编码（UTF-8/UTF-16/UTF-32）**：

对于带 `u8`、`u`、`U` 前缀的字面量，字符集中的每个字符按 ISO/IEC 10646 的 UCS 编码形式进行编码。

---

## 7. 标准术语变更与兼容性

C++23 通过 P2314R4 规范化了字符集相关术语：

| 新名称           | 旧名称           |
|------------------|------------------|
| 基本字符集       | 基本源字符集     |
| 基本字面量字符集 | 基本执行字符集   |
| 基本执行宽字符集 |                  |

自 C++23 起，源文件（非 UTF-8）到基本字符集（或转换字符集）的映射在转换阶段 1 由实现定义，需查阅具体编译器文档。

**总结与关系**：

整个流程可以概括为

- 物理源文件（各种编码） -> 被编译器读入，转换为统一的 翻译字符集（Unicode）。
- 编译器在 翻译字符集 的基础上，根据 基本字符集 的规则进行词法、语法分析。
- 源码中的字面量在预处理后被识别出来。
- 在编译期，这些字面量从翻译字符集 转换到执行字符集（用于 char）或宽执行字符集（用于 wchar_t 等）。
- 最终，转换后的字节序列被写入可执行文件。程序运行时，就使用对应的执行字符集来解释这些字符。

> 翻译字符集：编译器内部统一用的字符集（通常是 Unicode）。
>
> 基本字符集：C++ 语法必须支持的最基础字符。
>
> 基本字面量字符集：字面量能用的所有字符。
>
> 执行字符集/宽字符集：程序运行时实际用的编码。
>
> 代码单元/字面量编码：字符在内存/文件里的实际存储方式和转换过程。  

---

## 8. 缺陷报告与标准修订

| DR      | 应用于 | 已发布行为 | 正确行为 |
|---------|--------|------------|----------|
| CWG 788 | C++98  | 执行字符集的成员值原本是实现定义，但并非特定于区域设置 | 现为区域设置特定 |
| CWG 1796| C++98  | 基本执行（宽）字符集中空（宽）字符的表示所有位都是零 | 仅需值为零 |

---

## 9. 实践举例

### 9.1 判断字符是否为字母或数字

```cpp
#include <iostream>
#include <cctype>
int main() {
  char c = 'A';
  if (std::isalpha(c)) std::cout << "字母\n";
  if (std::isdigit(c)) std::cout << "数字\n";
  return 0;
}
```

### 9.2 字符编码与字符串

```cpp
#include <iostream>
int main() {
	std::string s = "Hello, 世界";
	std::cout << s << std::endl; // 可能因编码不同而输出不同
	return 0;
}
```

---

## 10. 参考资料

- ISO/IEC 14882:2020 (C++20) - Programming languages — C++
- cppreference.com
