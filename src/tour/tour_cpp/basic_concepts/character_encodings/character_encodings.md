## 字符集与编码- C++语言基础概念

本页描述C++标准定义的多个字符集。

```text
翻译字符集- 翻译字符集包含以下元素：
1. 每个被分配了Unicode码点的抽象字符
2. 每个未被分配抽象字符的Unicode标量值对应的独特字符
翻译字符集是基本字符集和基本字面字符集的超集（自C++23起）

基本字符集- 基本字符集包含以下96个字符（C++26前）/99个字符（C++26起）：
代码点        字符名称                字形
U+0009        字符制表符    
U+000B        行制表符    
U+000C        换页符(FF)    
U+0020        空格    
U+000A        换行符(LF)    新行
U+0021        感叹号                !
U+0022        引号                  "
U+0023        数字符号              #
U+0025        百分号                %
U+0026        和号                  &
U+0027        撇号                  '
U+0028        左圆括号              (
U+0029        右圆括号              )
U+002A        星号                  *
U+002B        加号                  +
U+002C        逗号                  ,
U+002D        连字符                -
U+002E        句号                  .
U+002F        斜线                  /
U+0030..U+0039 数字零到九           0 1 2 3 4 5 6 7 8 9
U+003A        冒号                  :
U+003B        分号                  ;
U+003C        小于号                <
U+003D        等号                  =
U+003E        大于号                >
U+003F        问号                  ?
U+0041..U+005A 拉丁大写字母A到Z     A B C D E F G H I J K L M N O P Q R S T U V W X Y Z
U+005B        左方括号              [
U+005C        反斜线                \
U+005D        右方括号              ]
U+005E        抑扬符                ^
U+005F        下划线                _
U+0061..U+007A 拉丁小写字母a到z     a b c d e f g h i j k l m n o p q r s t u v w x y z
U+007B        左花括号              {
U+007C        竖线                  |
U+007D        右花括号              }
U+007E        波浪号                ~
自C++26起，基本字符集新增以下字符：
代码点        字符名称        字形
U+0024        美元符号        $
U+0040        商用at符号      @
U+0060        重音符号        `

基本字面字符集- 基本字面字符集包含基本字符集的所有字符，以及以下控制字符：
代码点        字符
U+0000        空字符
U+0007        响铃
U+0008        退格
U+000D        回车(CR)

执行字符集
执行字符集和执行宽字符集是基本字面字符集的超集。执行字符集的编码和附加元素集合（如有）与本地环境相关。执行宽字符集的每个元素必须可表示为独特的wchar_t代码单元。

代码单元与字面编码
代码单元是字符类型的整数值。除多字符或不可编码字符外的字符字面量，或字符串字面量中的字符，按编码前缀确定为一个或多个代码单元序列，称为相应的字面编码。

字面编码或执行字符集的本地环境特定编码将基本字面字符集的每个元素编码为具有非负值的单个代码单元，且与其他元素的代码单元值不同。不在基本字面字符集中的字符可以用多个代码单元编码；此类代码单元的值可能与基本字面字符集元素的代码单元值相同。执行字符集的编码可能与任何字面编码无关。

普通字面编码应用于普通字符或字符串字面量。宽字面编码应用于宽字符或字符串字面量。

U+0000空字符编码为值0。翻译字符集的其他元素不以值为0的代码单元编码。数字0(U+0030)之后的每个十进制数字字符的代码单元值应比前一个数字大1。普通和宽字面编码的其他方面由实现定义。

对于UTF-8、UTF-16或UTF-32字面量，翻译字符集每个字符对应的UCS标量值按ISO/IEC 10646对相应UCS编码形式的规定进行编码。

注意
C++23通过P2314R4更改了某些字符集的标准名称：
新名称                旧名称
基本字符集            基本源字符集
基本字面字符集        基本执行字符集、基本执行宽字符集

在翻译阶段1中，从源文件字符（UTF-8源文件除外，自C++23起）到基本字符集（C++23前）/翻译字符集（C++23起）的映射由实现定义，因此要求实现文档说明基本源字符在源文件中的表示方式。

缺陷报告
以下行为变更缺陷报告被追溯应用于先前发布的C++标准：
DR     应用于     发布时的行为                 纠正后的行为
CWG 788 C++98     执行字符集的成员值由实现定义，但不与本地环境相关  改为与本地环境相关
CWG 1796 C++98    基本执行（宽）字符集中的空（宽）字符表示所有位为零  仅要求值为零
```

---

### C++ 字符集与编码深度解析

#### 1. **翻译字符集 (Translation Character Set)**

```cpp
// C++23 起，源文件字符直接映射到翻译字符集
char32_t unicode_char = U'😊'; // 直接使用 Unicode 标量值
```
- **定义**：编译器内部使用的统一字符表示
- **组成**：
  - 所有 Unicode 码点（U+0000 - U+10FFFF）
  - 未分配码点的独特字符（保留位置）
- **关键特性**：
  - **超集关系**：包含基本字符集和基本字面字符集
  - **处理阶段**：在翻译阶段1执行映射
  - **源文件处理**：
    ```mermaid
    graph LR
    A[源文件] --> B{UTF-8?}
    B -- 是 --> C[直接映射]
    B -- 否 --> D[实现定义映射]
    ```

#### 2. **基本字符集 (Basic Character Set)**

```cpp
// C++26 新增字符示例
std::string email = "user@host"; // @ (U+0040)
std::string price = "$100";      // $ (U+0024)
std::string template_param = "T`"; // ` (U+0060)
```

- **核心组成**：
  | **类别**       | **字符数** | **示例**                     | **C++26 变化**          |
  |----------------|------------|------------------------------|-------------------------|
  | 控制字符       | 5          | `\t` `\v` `\f` ` ` `\n`     | 无变化                  |
  | 标点符号       | 30         | `!` `"` `#` `%` `&` `'` 等  | 新增 `$` `@` `` ` ``    |
  | 数字           | 10         | `0-9`                        | 无变化                  |
  | 字母           | 52         | `A-Z` `a-z`                  | 无变化                  |
  | 其他符号       | 9          | `[\]^_{|}~`                  | 无变化                  |
  | **总计**       | **99**     |                              | 从 C++26 前的 96 增加   |

- **重要控制符**：
  | **代码点** | **名称**   | **C++ 表示** | **功能**               |
  |------------|------------|--------------|------------------------|
  | U+0009     | 制表符     | `\t`         | 水平对齐               |
  | U+000B     | 行制表符   | `\v`         | 垂直对齐（少用）       |
  | U+000C     | 换页符     | `\f`         | 打印机换页             |
  | U+0020     | 空格       | ` `          | 单词分隔               |
  | U+000A     | 换行符     | `\n`         | 行结束标志             |

#### 3. **基本字面字符集 (Basic Literal Character Set)**

```cpp
char null_char = '\0'; // U+0000
std::cout << "Alert\a"; // BEL (U+0007)
std::string backspace = "Back\bSpace"; // BS (U+0008)
```
- **扩展控制符**：
  | **代码点** | **字符** | **功能**               | **C++ 转义** |
  |------------|----------|------------------------|--------------|
  | U+0000     | NUL      | 字符串终止符           | `\0`         |
  | U+0007     | BEL      | 终端响铃               | `\a`         |
  | U+0008     | BS       | 光标左移               | `\b`         |
  | U+000D     | CR       | 回车                   | `\r`         |

- **编码要求**：
  - 所有字符必须有唯一非负整数值
  - 数字连续：`'1' - '0' == 1`
  - 空字符值为 0（CWG 1796 修正）

#### 4. **执行字符集 (Execution Character Set)**

```cpp
// 环境相关编码示例
setlocale(LC_ALL, "ja_JP.UTF-8");
std::cout << "日本語"; // 执行字符集编码依赖环境
```
- **关键特性**：
  - **超集**：包含基本字面字符集
  - **本地环境相关**：
    ```mermaid
    graph TB
    A[执行字符集] --> B[ASCII 环境]
    A --> C[Shift_JIS 环境]
    A --> D[GBK 环境]
    B --> E[单字节编码]
    C --> F[多字节编码]
    D --> G[混合编码]
    ```
  - **宽字符集要求**：
    - 每个字符有唯一 `wchar_t` 表示
    - 大小由实现定义（Windows: 2 字节，Linux: 4 字节）

#### 5. **代码单元与字面编码**

```cpp
// 不同前缀的编码示例
char8_t utf8_char = u8'α';    // 2 字节代码单元序列
char16_t utf16_char = u'β';   // 1 个 char16_t 代码单元
char32_t utf32_char = U'γ';   // 1 个 char32_t 代码单元
wchar_t wide_char = L'δ';     // 实现定义
```
- **编码规则**：
  | **前缀** | **编码类型**       | **标准**         | **字符类型** | **代码单元大小** |
  |----------|--------------------|------------------|--------------|------------------|
  | 无       | 普通字面编码       | 实现定义         | `char`       | 1 字节           |
  | `L`      | 宽字面编码         | 实现定义         | `wchar_t`    | 实现定义         |
  | `u8`     | UTF-8              | ISO/IEC 10646    | `char8_t`    | 1 字节           |
  | `u`      | UTF-16 (C++23 起)  | ISO/IEC 10646    | `char16_t`   | 2 字节           |
  | `U`      | UTF-32 (C++23 起)  | ISO/IEC 10646    | `char32_t`   | 4 字节           |

- **核心约束**：
  - U+0000 必须编码为 0
  - 禁止使用 0 值编码其他字符
  - 数字必须连续编码

#### 6. **字符集演进与标准变更**

```cpp
#if __cplusplus >= 202302L
// C++26 代码
constexpr bool has_new_chars = 
    ('$' == u'$') && ('@' == u'@') && ('`' == u'`');
#endif
```

- **术语变更 (C++23)**：
  | **新术语**         | **旧术语**             |
  |--------------------|------------------------|
  | 基本字符集         | 基本源字符集           |
  | 基本字面字符集     | 基本执行字符集         |
  |                    | 基本执行宽字符集       |

- **C++26 新增字符**：
  | **字符** | **代码点** | **应用场景**               |
  |----------|------------|----------------------------|
  | $        | U+0024     | 模板参数/变量名 (`T$`)     |
  | @        | U+0040     | 电子邮件地址 (`user@host`) |
  | `        | U+0060     | 模板语法 (`vector<T`>`)    |

#### 7. **缺陷报告解析**
- **CWG 788**：
  ```cpp
  // 修正前：执行字符集编码完全实现定义
  // 修正后：执行字符集编码与本地环境相关
  std::setlocale(LC_CTYPE, "en_US.UTF-8");
  char euro_sign = '€'; // 编码依赖当前区域设置
  ```

- **CWG 1796**：
  ```cpp
  // 修正前：空字符要求所有位为0
  // 修正后：空字符只需整数值为0
  char null_char = '\0';
  static_assert(null_char == 0, "Value must be zero");
  // 不再要求位模式全零（适用于非二进制补码系统）
  ```

#### 8. **多字节字符处理**

```cpp
// 多字节字符串操作
std::string mb_str = "日本語";
size_t char_count = std::mblen(mb_str.c_str(), MB_CUR_MAX);

// 宽字符转换
std::wstring_convert<std::codecvt_utf8<wchar_t>> converter;
std::wstring wide_str = converter.from_bytes(mb_str);
```

#### 9. **Unicode 标识符支持 (C++11 起)**

```cpp
int résumé = 1;      // 带重音字符
double Δ = 1.618;   // 希腊字母
class クラス {};     // 日文片假名
```

#### 10. **跨平台编码最佳实践**

```cpp
#include <string>
#include <codecvt>
#include <locale>

std::string to_utf8(const std::wstring& wide_str) {
    std::wstring_convert<std::codecvt_utf8<wchar_t>> converter;
    return converter.to_bytes(wide_str);
}

std::wstring from_utf8(const std::string& utf8_str) {
    std::wstring_convert<std::codecvt_utf8<wchar_t>> converter;
    return converter.from_bytes(utf8_str);
}

void safe_print(const std::string& str) {
    // 确保使用UTF-8控制台
    #ifdef _WIN32
        SetConsoleOutputCP(CP_UTF8);
    #endif
    std::cout << str;
}
```

#### 11. **编译时字符处理 (C++17 起)**

```cpp
constexpr bool is_basic_char(char32_t c) {
    // 检查是否属于基本字符集
    return (c >= U'\t' && c <= U'~') || 
           (c >= U'$' && c <= U'`'); // C++26扩展
}

static_assert(is_basic_char(U'A'));
static_assert(!is_basic_char(U'€'));
```

> C++ 的字符处理架构经历了从实现定义到标准化的演进。C++23 统一了字符集术语并强化了翻译字符集的作用，C++26 则通过添加 `$`、`@` 和 `` ` `` 三个关键字符使基本字符集更贴合现代编程需求。理解执行字符集的环境相关性、不同字面编码的映射规则，以及空字符的精确要求（CWG 1796），对开发跨平台国际化应用至关重要。现代 C++ 通过 `char8_t`/`char16_t`/`char32_t` 类型和标准转换工具，为 Unicode 处理提供了坚实基础。